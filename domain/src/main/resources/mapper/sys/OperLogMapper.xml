<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ecoshop.dao.mapper.sys.OperLogMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.ecoshop.dao.po.sys.OperLogPO">
        <id column="id" property="id"/>
        <result column="tenant_id" property="tenantId"/>
        <result column="title" property="title"/>
        <result column="business_type" property="businessType"/>
        <result column="method" property="method"/>
        <result column="request_method" property="requestMethod"/>
        <result column="operator_type" property="operatorType"/>
        <result column="oper_name" property="operName"/>
        <result column="dept_name" property="deptName"/>
        <result column="oper_url" property="operUrl"/>
        <result column="oper_ip" property="operIp"/>
        <result column="oper_location" property="operLocation"/>
        <result column="oper_param" property="operParam"/>
        <result column="json_result" property="jsonResult"/>
        <result column="status" property="status"/>
        <result column="error_msg" property="errorMsg"/>
        <result column="oper_time" property="operTime"/>
        <result column="cost_time" property="costTime"/>
        <result column="version" property="version"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id, tenant_id, title, business_type, method, request_method, operator_type, oper_name, dept_name,
        oper_url, oper_ip, oper_location, oper_param, json_result, status, error_msg, oper_time, cost_time,
        version, created_at, updated_at
    </sql>

    <!-- 根据ID查询操作日志 -->
    <select id="selectById" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_oper_log
        WHERE id = #{id}
    </select>

    <!-- 查询操作日志列表 -->
    <select id="selectList" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM sys_oper_log
        <where>
            <if test="tenantId != null">
                AND tenant_id = #{tenantId}
            </if>
            <if test="title != null and title != ''">
                AND title LIKE CONCAT('%', #{title}, '%')
            </if>
            <if test="businessType != null">
                AND business_type = #{businessType}
            </if>
            <if test="operatorType != null">
                AND operator_type = #{operatorType}
            </if>
            <if test="operName != null and operName != ''">
                AND oper_name LIKE CONCAT('%', #{operName}, '%')
            </if>
            <if test="deptName != null and deptName != ''">
                AND dept_name LIKE CONCAT('%', #{deptName}, '%')
            </if>
            <if test="status != null">
                AND status = #{status}
            </if>
        </where>
        ORDER BY oper_time DESC
    </select>

    <!-- 新增操作日志 -->
    <insert id="insert" parameterType="com.ecoshop.dao.po.sys.OperLogPO" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO sys_oper_log (
            tenant_id, title, business_type, method, request_method, operator_type, oper_name, dept_name,
            oper_url, oper_ip, oper_location, oper_param, json_result, status, error_msg, oper_time, cost_time, version
        ) VALUES (
            #{tenantId}, #{title}, #{businessType}, #{method}, #{requestMethod}, #{operatorType}, #{operName},
            #{deptName}, #{operUrl}, #{operIp}, #{operLocation}, #{operParam}, #{jsonResult}, #{status},
            #{errorMsg}, #{operTime}, #{costTime}, 1
        )
    </insert>

    <!-- 修改操作日志 -->
    <update id="update" parameterType="com.ecoshop.dao.po.sys.OperLogPO">
        UPDATE sys_oper_log
        <set>
            <if test="title != null">
                title = #{title},
            </if>
            <if test="businessType != null">
                business_type = #{businessType},
            </if>
            <if test="method != null">
                method = #{method},
            </if>
            <if test="requestMethod != null">
                request_method = #{requestMethod},
            </if>
            <if test="operatorType != null">
                operator_type = #{operatorType},
            </if>
            <if test="operName != null">
                oper_name = #{operName},
            </if>
            <if test="deptName != null">
                dept_name = #{deptName},
            </if>
            <if test="operUrl != null">
                oper_url = #{operUrl},
            </if>
            <if test="operIp != null">
                oper_ip = #{operIp},
            </if>
            <if test="operLocation != null">
                oper_location = #{operLocation},
            </if>
            <if test="operParam != null">
                oper_param = #{operParam},
            </if>
            <if test="jsonResult != null">
                json_result = #{jsonResult},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="errorMsg != null">
                error_msg = #{errorMsg},
            </if>
            <if test="operTime != null">
                oper_time = #{operTime},
            </if>
            <if test="costTime != null">
                cost_time = #{costTime},
            </if>
            version = version + 1,
            updated_at = CURRENT_TIMESTAMP
        </set>
        WHERE id = #{id} AND version = #{version}
    </update>

    <!-- 删除操作日志 -->
    <delete id="deleteById">
        DELETE FROM sys_oper_log WHERE id = #{id}
    </delete>

    <!-- 批量删除操作日志 -->
    <delete id="deleteBatchIds">
        DELETE FROM sys_oper_log WHERE id IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 清空操作日志 -->
    <delete id="cleanOperLog">
        TRUNCATE TABLE sys_oper_log
    </delete>

</mapper> 